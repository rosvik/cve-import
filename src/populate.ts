import { DbRow } from "./types/types";
import { DB } from "./utils/DB";
import { Git } from "./utils/Git";
import { getAllFileNames, getCveFromFile } from "./utils/files";

const BATCH_SIZE = 100;

/**
 * Populate empty database in batches. Ignore pre-existing rows.
 */
export async function populate(database: DB, git: Git) {
  const files: string[] = getAllFileNames(git.dir);
  let rows: DbRow[] = [];

  for (let n = 0; n < files.length; n++) {
    const path = files[n];
    if (!path) continue;

    const cve = getCveFromFile(path);
    if (cve) rows.push(cve);

    if (n % BATCH_SIZE === 0) {
      const percentage = ((n / files.length) * 100).toFixed(1);
      const fromId = rows[0].id;
      const toId = rows[rows.length - 1].id;
      console.log(`${n} of ${files.length} (${percentage}%)`);
      console.log(`Uploading from ${fromId} to ${toId}`);

      await database.populate(rows);

      console.log("Done");
      rows = [];
    }
  }
}
