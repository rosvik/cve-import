import { DB } from "./utils/DB";
import { Git } from "./utils/Git";
import { getAllFileNames, getCveFromFile } from "./utils/cveFiles";

/**
 * Update CVEs already in database, one by one
 */
export async function update(database: DB, git: Git) {
  const files: string[] = getAllFileNames(git.dir);

  for (let n = files.length; n > 0; n--) {
    const path = files[n];
    if (!path) continue;

    const cve = getCveFromFile(path);

    if (cve) {
      await database.upsertRow(cve);
    }

    const index = files.length - n;
    if (index % 100 === 0 || n === files.length - 1) {
      const percentage = ((index / files.length) * 100).toFixed(1);
      console.log(`${index} of ${files.length} (${percentage}%)`);
      console.log(`Updated ${cve?.id}`);
    }
  }
}
