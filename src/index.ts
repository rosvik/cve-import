import minimist from "minimist";
import { iterate } from "./iterate";
import { populate } from "./populate";
import { update } from "./update";
import { DB } from "./utils/db";

const DB_CONNECTION = new DB();

const CVE_LIST_PATH = "./cvelistV5/cves";
const BATCH_SIZE = 100;

async function main() {
  const args = minimist(process.argv.slice(2));
  if (!["populate", "update", "iterate"].includes(args.mode)) {
    throw new Error("Specify a mode: populate, update, or iterate");
  }

  if (args.mode === "populate") {
    await populate(DB_CONNECTION, CVE_LIST_PATH, BATCH_SIZE);
  } else if (args.mode === "update") {
    await update(DB_CONNECTION, CVE_LIST_PATH, BATCH_SIZE);
  } else if (args.mode === "iterate") {
    await iterate();
  }
}

main()
  .then(async () => {
    await DB_CONNECTION.disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await DB_CONNECTION.disconnect();
    process.exit(1);
  });
