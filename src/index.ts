import minimist from "minimist";
import { iterate } from "./iterate";
import { populate } from "./populate";
import { update } from "./update";
import { DB } from "./utils/DB";
import { Git } from "./utils/Git";

const DB_CONNECTION = new DB();
const GIT_PATH = "../cvelistV5";

async function main() {
  const args = minimist(process.argv.slice(2));
  if (!["populate", "update", "iterate", "get"].includes(args.mode)) {
    throw new Error("Specify a mode: populate, update, or iterate");
  }

  if (args.mode === "get") {
    const id = args.id;
    if (!id) throw new Error("Specify an ID with --id");
    const row = await DB_CONNECTION.getRow(id);
    console.log(JSON.stringify(row, null, 2));
    return;
  }

  const git = new Git(GIT_PATH, true);
  await git.fetch();
  await git.reset();
  git.setDebug(false);

  if (args.mode === "populate") {
    await populate(DB_CONNECTION, git);
  } else if (args.mode === "update") {
    await update(DB_CONNECTION, git, args["start-at"]);
  } else if (args.mode === "iterate") {
    await iterate(DB_CONNECTION, git);
  }
}

main()
  .then(async () => {
    await DB_CONNECTION.disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await DB_CONNECTION.disconnect();
    process.exit(1);
  });
