import ajv from "ajv";
import addFormats from "ajv-formats";
import { v5Schema } from "../schemas/v5-schema";

import type { CVE, Published, Rejected } from "../types/cve";

const validate = (() => {
  const Ajv = addFormats(new ajv());
  return Ajv.compile(v5Schema);
})();

export function validateJSON(data: any): CVE | undefined {
  if (!validate(data)) {
    console.log("Validation failed");
    console.log(data);
    console.log(validate.errors);
    return;
  }

  const cve = data as unknown as CVE;
  if (!cve.cveMetadata) {
    console.log("No cveMetadata");
    console.log(cve);
    console.log(validate.errors);
    return;
  }

  return cve;
}

export function isPublished(input: CVE | undefined): input is Published {
  return !!input && input.cveMetadata.state === "PUBLISHED";
}

export function isRejected(input: CVE | undefined): input is Rejected {
  return !!input && input.cveMetadata.state === "REJECTED";
}
