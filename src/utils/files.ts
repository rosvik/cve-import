import { readdirSync, readFileSync } from "fs";
import { DbRow } from "../types/types";
import { isPublished, validateJSON } from "./validator";
import { CVE } from "../types/cve";
import { parseDateAsUTC } from "./utils";

const CVE_LIST_BASE = "/cves";

/**
 * Get the path of every json file in the cvelistV5 git repository.
 *
 * @param gitPath Path to the cvelistV5 git repository
 * @returns An array of file paths
 */
export function getAllFileNames(gitPath: string): string[] {
  const cveDir = gitPath + CVE_LIST_BASE;
  const z = readdirSync(cveDir, { withFileTypes: true });
  const files: string[] = [];

  const yearDirs = z.filter((f) => f.isDirectory() && !f.name.startsWith("."));
  yearDirs.forEach((yearDir) => {
    const pathA = `${cveDir}/${yearDir.name}/`;
    const nDirs = readdirSync(pathA, { withFileTypes: true }).filter((n) =>
      n.isDirectory()
    );
    nDirs.forEach((n) => {
      const pathB = `${pathA}${n.name}/`;
      const cveFiles = readdirSync(pathB, { withFileTypes: true }).filter((n) =>
        n.isFile()
      );
      cveFiles.forEach((f) => {
        if (f.name.endsWith(".json")) {
          files.push(pathB + f.name);
        } else {
          console.warn(pathB + f.name);
        }
      });
    });
  });

  return files;
}

/**
 * Get JSON data from a given file path, formatted as a DbRow.
 *
 * @param path Absolute path to the json file
 * @returns The CVE data, id and json
 */
export function getCveFromFile(path: string): DbRow | undefined {
  const fileContents = readFileSync(path);
  const j = JSON.parse(fileContents.toString());
  const CVE = validateJSON(j);
  if (!CVE) return;
  return formatToDbRow(CVE, j);
}

/**
 * Get path to the json file relative to cvelistV5 git root.
 *
 * @param id The CVE id
 * @returns The path to the json file
 * @example
 * `filePathById("CVE-2021-1234")` returns `/cves/2021/1xxx/CVE-2021-1234.json`
 */
export function filePathById(id: string): string {
  // `CVE-YYYY-NNNNN`
  const year = id.slice(4, 8); // YYYY
  const num = id.slice(9); // NNNNN
  const group = `${num.slice(0, -3)}xxx`;

  return `${CVE_LIST_BASE}/${year}/${group}/${id}.json`;
}

function formatToDbRow(cve: CVE, json: any): DbRow {
  if (isPublished(cve)) {
    return {
      id: cve.cveMetadata.cveId,
      json,

      dataType: cve.dataType,
      dataVersion: cve.dataVersion,
      cveMetadata_cveId: cve.cveMetadata.cveId,
      cveMetadata_assignerOrgId: cve.cveMetadata.assignerOrgId,
      cveMetadata_assignerShortName: cve.cveMetadata.assignerShortName ?? null,
      cveMetadata_requesterUserId: cve.cveMetadata.requesterUserId ?? null,
      cveMetadata_dateUpdated:
        parseDateAsUTC(cve.cveMetadata.dateUpdated) ?? null,
      cveMetadata_serial: cve.cveMetadata.serial ?? null,
      cveMetadata_dateReserved:
        parseDateAsUTC(cve.cveMetadata.dateReserved) ?? null,
      cveMetadata_dateRejected: null,
      cveMetadata_datePublished:
        parseDateAsUTC(cve.cveMetadata.datePublished) ?? null,
      cveMetadata_state: cve.cveMetadata.state,
      containers_cna_providerMetadata_orgId:
        cve.containers.cna.providerMetadata.orgId,
      containers_cna_providerMetadata_shortName:
        cve.containers.cna.providerMetadata.shortName ?? null,
      containers_cna_providerMetadata_dateUpdated:
        parseDateAsUTC(cve.containers.cna.providerMetadata.dateUpdated) ?? null,
      containers_cna_dateAssigned:
        parseDateAsUTC(cve.containers.cna.dateAssigned) ?? null,
      containers_cna_datePublic:
        parseDateAsUTC(cve.containers.cna.datePublic) ?? null,
      containers_cna_title: cve.containers.cna.title ?? null,
      containers_cna_descriptions: cve.containers.cna.descriptions ?? null,
      containers_cna_affected: cve.containers.cna.affected ?? null,
      containers_cna_problemTypes: cve.containers.cna.problemTypes ?? [],
      containers_cna_references: cve.containers.cna.references ?? null,
      containers_cna_impacts: cve.containers.cna.impacts ?? [],
      containers_cna_metrics: cve.containers.cna.metrics ?? [],
      containers_cna_configurations: cve.containers.cna.configurations ?? [],
      containers_cna_workarounds: cve.containers.cna.workarounds ?? [],
      containers_cna_solutions: cve.containers.cna.solutions ?? [],
      containers_cna_exploits: cve.containers.cna.exploits ?? [],
      containers_cna_timeline: cve.containers.cna.timeline ?? [],
      containers_cna_credits: cve.containers.cna.credits ?? [],
      containers_cna_source: cve.containers.cna.source ?? undefined,
      containers_cna_tags: cve.containers.cna.tags ?? [],
      containers_cna_taxonomyMappings:
        cve.containers.cna.taxonomyMappings ?? [],
      containers_cna_rejectedReasons: [],
      containers_cna_replacedBy: [],
      containers_adp: cve.containers.adp ?? [],
    };
  } else {
    return {
      id: cve.cveMetadata.cveId,
      json,

      dataType: cve.dataType,
      dataVersion: cve.dataVersion,
      cveMetadata_cveId: cve.cveMetadata.cveId,
      cveMetadata_assignerOrgId: cve.cveMetadata.assignerOrgId,
      cveMetadata_assignerShortName: cve.cveMetadata.assignerShortName ?? null,
      cveMetadata_requesterUserId: null,
      cveMetadata_dateUpdated:
        parseDateAsUTC(cve.cveMetadata.dateUpdated) ?? null,
      cveMetadata_serial: cve.cveMetadata.serial ?? null,
      cveMetadata_dateReserved:
        parseDateAsUTC(cve.cveMetadata.dateReserved) ?? null,
      cveMetadata_dateRejected: null,
      cveMetadata_datePublished:
        parseDateAsUTC(cve.cveMetadata.datePublished) ?? null,
      cveMetadata_state: cve.cveMetadata.state,
      containers_cna_providerMetadata_orgId:
        cve.containers.cna.providerMetadata.orgId,
      containers_cna_providerMetadata_shortName:
        cve.containers.cna.providerMetadata.shortName ?? null,
      containers_cna_providerMetadata_dateUpdated:
        parseDateAsUTC(cve.containers.cna.providerMetadata.dateUpdated) ?? null,
      containers_cna_dateAssigned: null,
      containers_cna_datePublic: null,
      containers_cna_title: null,
      containers_cna_descriptions: [],
      containers_cna_affected: [],
      containers_cna_problemTypes: [],
      containers_cna_references: [],
      containers_cna_impacts: [],
      containers_cna_metrics: [],
      containers_cna_configurations: [],
      containers_cna_workarounds: [],
      containers_cna_solutions: [],
      containers_cna_exploits: [],
      containers_cna_timeline: [],
      containers_cna_credits: [],
      containers_cna_source: undefined,
      containers_cna_tags: [],
      containers_cna_taxonomyMappings: [],
      containers_cna_rejectedReasons: cve.containers.cna.rejectedReasons,
      containers_cna_replacedBy: cve.containers.cna.replacedBy ?? [],
      containers_adp: [],
    };
  }
}
